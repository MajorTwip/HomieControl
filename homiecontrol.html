<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  <title>HomieControl</title>
</head>

<body>

  <div class="container">
    <h1>HomieControl</h1>
    <h2>for Homie v3</h2>

    <div class="panel panel-info">
      <div class="panel-heading">
        <div class="panel-title">Server</div>
      </div>
      <div class="panel-body">
        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="server_url">MQTT Server</label>
            <input type="url" class="form-control" id="server_url" placeholder="example.com" value="mqtt.comstock.ch">
          </div>
          <div class="form-group col-md-2">
            <label for="server_port">Port</label>
            <input type="number" class="form-control" id="server_port" value="9001" min="1" max="65535">
          </div>
          <div class="form-group col-md-4">
            <label for="base_topic">Homie Basetopic</label>
            <input type="url" class="form-control" id="base_topic" value="csh/">
          </div>
          <div class="form-group col-md-4">
            <input type="button" class="form-control" id="srv_connect" value="Connect">
          </div>
        </div>
      </div>
    </div>

    <div class="panel panel-info">
      <div class="panel-heading">
        <div class="panel-title">Firmware</div>
      </div>
      <div class="panel-body">
        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="file_path">MQTT Server</label>
            <input type="file" class="form-control" id="file_path" placeholder="firmware.bin"
              onchange="firmwareselected()">
          </div>
          <div class="form-group col-md-6">
            <div class="form-group">
              <label for="fw_md5">MD5 Hash</label>
              <input type="text" readonly class="form-control" id="fw_md5" placeholder="NA">
            </div>
            <div class="form-group">
              <label for="fw_name">Fw Name (for HomieESP)</label>
              <input type="text" readonly class="form-control" id="fw_name" placeholder="NA">
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="deviceslist" class="row"></div>
    <div class="panel panel-info col-md-4 homiedevice invisible" id="homiedevice_template">
      <div class="panel-heading">
        <div class="panel-title device-name">HomieDevice</div>
      </div>
      <div class="panel-body device-info">
          <div id="info_template"><label class="info_label">Version</label><input type="text" readonly class="form-control info_text" placeholder="NA"></div>
      </div>
      <div class="panel-footer device-ota">
          <div class="device-ota-status progress-bar progress-bar-striped progress-bar-animated invisible" role="progressbar" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">fd</div>
          <input type="button" class="form-control update-button" value="Update">
      </div>
    </div>



  </div>


  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/md5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

  <script>
    $("#srv_connect").bind("click", srv_connect);


    var fw;
    var fw_md5;

    var mqtt;
    var mqtt_reconnect = 2000;
    var basetopic;

    var devices = new Map();
    var deviceinfos = new Map();
    deviceinfos.set("/$fw/version", "FW-Version");
    deviceinfos.set("/$name", "Name");
    deviceinfos.set("/$fw/name", "FW-Name");
    deviceinfos.set("/$state","State");
    deviceinfos.set("/$implementation/ota/enabled", "OTA-Enabled");
    deviceinfos.set("/$implementation/ota/status", "OTA-Status");


    function getMD5() {
      let md5_field = document.getElementById("fw_md5");
      let hash = CryptoJS.MD5(CryptoJS.enc.Latin1.parse(fw));
      fw_md5 = hash.toString(CryptoJS.enc.Hex);
      $(md5_field).val(fw_md5);
    }

    function getFwName() {
      let fwNameMBprefix = String.fromCharCode(0xBF, 0x84, 0xE4, 0x13, 0x54);
      let fwNameMBpostfix = String.fromCharCode(0x93, 0x44, 0x6B, 0xA7, 0x75);
      let fw_namestr = fw.substring(fw.indexOf(fwNameMBprefix) + fwNameMBprefix.length, fw.indexOf(fwNameMBpostfix));
      $("#fw_name").val(fw_namestr);
      console.log(fw_namestr);
    }

    function firmwareselected() {
      console.log("Firmware selected");
      let fw_select = document.getElementById("file_path").files[0];
      console.log(fw_select);
      let reader = new FileReader();

      reader.addEventListener(
        'load',
        function () {
          fw = this.result;
          getMD5();
          getFwName();
        }
      );
      reader.readAsBinaryString(fw_select);
    }

    function onConnect() {
      console.log("connected");
      $("#srv_connect").val("Disconnect");
      $("#srv_connect").unbind();
      $("#srv_connect").bind("click", srv_disconnect);

      basetopic = $("#base_topic").val().trim();
      if (basetopic.slice(-1) != '/') {
        basetopic = basetopic + "/"
      };
      let topic = basetopic + "+";
      deviceinfos.forEach(function (val, top) {
        console.log("Subscribe to " + topic + top);
        mqtt.subscribe(topic + top);
      });

    }

    function srv_disconnect() {
      mqtt.disconnect();
      console.log("disconnected");
      $("#srv_connect").val("Connect");
      $("#srv_connect").unbind();
      $("#srv_connect").bind("click", srv_connect);
    }

    function srv_connect() {
      mqtt = new Paho.MQTT.Client($("#server_url").val(), parseInt($("#server_port").val()), "HomieControl");
      mqtt.onConnectionLost = onConnectionLost;
      mqtt.onFailure = onFailure;
      mqtt.onMessageArrived = onMessageArrived;
      var options = {
        timeout: 3,
        onSuccess: onConnect,
      };
      mqtt.connect(options);
    }

    function onConnectionLost(responseObject) {
      if (responseObject.errorCode !== 0) {
        console.log("onConnectionLost:" + responseObject.errorMessage);
      }
      timeout(srv_connect,mqtt_reconnect);
    }

    function onFailure(message){
      console.log("Connection attempt failed: " + message);
      timeout(srv_connect,mqtt_reconnect);
    }

    function onMessageArrived(message) {
      let dest = message.destinationName;
      let device_id = dest.split('/')[1];
      let sub = dest.slice(dest.indexOf(device_id) + device_id.length);
      if (!devices.has(device_id)) {
        let device = new Map();
        device.set(deviceinfos.get(sub), message.payloadString);
        devices.set(device_id, device);
      } else {
        let device = devices.get(device_id);
        device.set(deviceinfos.get(sub), message.payloadString);
        devices.set(device_id, device);
      }
      //console.log(devices);
      if(sub=="/$implementation/ota/status"){
        progressOTA(device_id);
      }
      else{
        updateDevice(device_id);
      }

    }

    function updateDevice(device_id) {
      let device=devices.get(device_id);
      let $devicepanel = $("#" + device_id + "_panel");
      if ($devicepanel.length == 0) {
        let $template = $("#homiedevice_template").clone();
        $template.attr("id",device_id+"_panel");
        $template.removeClass("invisible");
        $template.find(".device-info").text(""); 
        $template.appendTo($("#deviceslist"));
        $devicepanel = $template;
      }
      device.forEach(function(val,key){
        if(key=="Name"){
        $devicepanel.find(".device-name").text(device.get("Name"));
      }else{
        $deviceinfo = $devicepanel.find(".device-info");
        $infoline = $deviceinfo.find("#"+device_id + key);
        if($infoline.length==0){
          console.log("Add line " + key + " to " + device_id);
          $infoline=$("#info_template").clone();
          $infoline.attr("id",device_id+key)
          $infoline.appendTo($deviceinfo);
        }
        $infoline.find(".info_label").text(key);
        $infoline.find(".info_text").val(val);
      }
      });
      if(device.has("OTA-Enabled")){
        if(device.get("OTA-Enabled")=="true"){
          $devicepanel.find(".update-button").attr("value","Update").unbind().bind("click",function(){updateFw(device_id);});
        }else{
          $devicepanel.find(".update-button").unbind().attr("value","OTA disabled");
        }
      }else{
        $devicepanel.find(".update-button").unbind().attr("value","OTA not available");
      }
    }

    function updateFw(device_id){
      console.log("Update " + device_id);
      let $devicefooter = $("#" + device_id + "_panel>.device-ota");
      $devicefooter.find(".update-button").addClass("invisible");

      let message = new Paho.MQTT.Message(btoa(fw));
      message.destinationName = String(basetopic + device_id + "/$implementation/ota/firmware/" + fw_md5);
      $devicefooter.find(".device-ota-status").removeClass("invisible");
      console.log(message);
      mqtt.send(message);
    }

    function progressOTA(device_id){
      let $devicefooter = $("#" + device_id + "_panel>.device-ota");
      let $bar = $devicefooter.find(".device-ota-status");
      let state = devices.get(device_id).get("OTA-Status");
      let statecode = state.split(" ")[0];
      let stateinfo = state.split(" ")[1];
      console.log("code: " + statecode + "  info: " + stateinfo);
      switch(statecode.trim()){
        case "400":
        $bar.text("Invalid FW");
        $bar.addClass("progress-bar-danger");
        $bar.attr("style","");
        $devicefooter.find(".update-button").removeClass("invisible");
        break;

        case "206":
        let percent = stateinfo.split("/")[0] / stateinfo.split("/")[1] * 100;
        $bar.attr("style","width:"+ percent +"%");
        $bar.addClass("progress-bar-info").removeClass("progress-bar-danger");
        $bar.text(stateinfo);
        break;

        case "200":
        $bar.text("Update successful");
        $bar.addClass("progress-bar-success").removeClass("progress-bar-danger");
        $bar.attr("style","");
        $devicefooter.find(".update-button").removeClass("invisible");
        break;

        default:
        $bar.text(state);
        $devicefooter.find(".update-button").removeClass("invisible");
        $bar.attr("style","");


      }
    }

  </script>
</body>

</html>
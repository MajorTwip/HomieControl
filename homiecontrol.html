<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

  <title>HomieControl</title>
</head>

<body>

  <div class="container">
    <h1>HomieControl</h1>
    <h2>for Homie v3</h2>

    <div class="panel panel-info">
      <div class="panel-heading">
        <div class="panel-title">Server</div>
      </div>
      <div class="panel-body">
        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="server_url">MQTT Server</label>
            <input type="url" class="form-control" id="server_url" placeholder="example.com">
          </div>
          <div class="form-group col-md-2">
            <label for="server_port">Port</label>
            <input type="number" class="form-control" id="server_port" value="9001" min="1" max="65535">
          </div>
          <div class="form-group col-md-4">
            <label for="base_topic">Homie Basetopic</label>
            <input type="url" class="form-control" id="base_topic" value="homie/">
          </div>
          <div class="form-group col-md-4">
              <input type="button" class="form-control" id="srv_connect" value="Connect" onclick="srv_connect()">
            </div>
        </div>
      </div>
    </div>

    <div class="panel panel-info">
        <div class="panel-heading">
          <div class="panel-title">Firmware</div>
        </div>
        <div class="panel-body">
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="file_path">MQTT Server</label>
              <input type="file" class="form-control" id="file_path" placeholder="firmware.bin" onchange="firmwareselected()">
            </div>
            <div class="form-group col-md-6">
                <div class="form-group">
                    <label for="fw_md5">MD5 Hash</label>
                    <input type="text" readonly class="form-control" id="fw_md5" placeholder="NA">
                </div>
                <div class="form-group">
                    <label for="fw_name">Fw Name (for HomieESP)</label>
                    <input type="text" readonly class="form-control" id="fw_name" placeholder="NA">
                </div>
            </div>
          </div>
        </div>
      </div>



  </div>


  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/md5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

  <script>
    var fw;
    var fw_md5;

    var mqtt;
    var mqtt_reconnect = 2000;

    function getMD5(){
      let md5_field = document.getElementById("fw_md5");
      let hash = CryptoJS.MD5(CryptoJS.enc.Latin1.parse(fw));
      fw_md5 = hash.toString(CryptoJS.enc.Hex);
      $(md5_field).val(fw_md5);
    }

    function getFwName(){
      let fwNameMBprefix = String.fromCharCode(0xBF, 0x84, 0xE4, 0x13, 0x54);
      let fwNameMBpostfix = String.fromCharCode(0x93, 0x44, 0x6B, 0xA7, 0x75);
      let fw_namestr = fw.substring(fw.indexOf(fwNameMBprefix)+fwNameMBprefix.length,fw.indexOf(fwNameMBpostfix));
      $("#fw_name").val(fw_namestr);
      console.log(fw_namestr);
    }

    function firmwareselected(){
      console.log("Firmware selected");
      let fw_select = document.getElementById("file_path").files[0];
      console.log(fw_select);
      let reader = new FileReader();

      reader.addEventListener(
            'load',
            function () {
                fw = this.result;
                getMD5();
                getFwName();
            }
        );
      reader.readAsBinaryString(fw_select);
    }

    function onConnect(){
      console.log("connected");
      $(".srv_connect").text("Disconnect");
      $(".srv_connect").off("click");
      $(".srv_connect").addEventListener("click", srv_disconnect);
    }

    function srv_disconnect(){
      mqtt.disconnect();
      console.log("connected");
      $(".srv_connect").text("Connect");
    }

    function srv_connect(){
      mqtt = new Paho.MQTT.Client($("#server_url").val(),parseInt($("#server_port").val()),"HomieControl");
      var options = {
        timeout: 3,
        onSuccess: onConnect,
      };
      mqtt.connect(options);
    }
  </script>
</body>

</html>